# é‡ç™¾çµé¤é¥®é›†å›¢ - MVPæ•°æ®åº“å¿«é€Ÿå…¥é—¨

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿå®‰è£…](#å¿«é€Ÿå®‰è£…)
2. [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
3. [åŒæˆæœ¬ç‡ç³»ç»Ÿè¯¦è§£](#åŒæˆæœ¬ç‡ç³»ç»Ÿè¯¦è§£)
4. [æ•°æ®å¯¼å…¥æµç¨‹](#æ•°æ®å¯¼å…¥æµç¨‹)
5. [å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹](#å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹)

---

## ğŸš€ å¿«é€Ÿå®‰è£…

### ç¬¬1æ­¥: åˆ›å»ºæ•°æ®åº“

```bash
createdb ybl_restaurant
psql ybl_restaurant -c "CREATE EXTENSION pgcrypto;"
```

### ç¬¬2æ­¥: æ‰§è¡ŒSQLè„šæœ¬(æŒ‰é¡ºåº)

```bash
# ===== é˜¶æ®µ1: æ ¸å¿ƒè¡¨ç»“æ„ =====
psql ybl_restaurant -f schema_core_mvp.sql

# ===== é˜¶æ®µ2: å‡½æ•°ä¸è§¦å‘å™¨ =====
psql ybl_restaurant -f functions_cost_encryption.sql
psql ybl_restaurant -f functions_bom_explosion.sql
psql ybl_restaurant -f triggers_automatic_calculation.sql
psql ybl_restaurant -f procedures_data_validation.sql
psql ybl_restaurant -f views_financial_analysis.sql

# ===== é˜¶æ®µ3: åŸºç¡€æ•°æ® =====
psql ybl_restaurant -f data_init_mvp.sql              # è®¡é‡å•ä½ã€å“ç±» (22å•ä½+7å“ç±»)
psql ybl_restaurant -f data_organization_stores.sql   # ç»„ç»‡æ¶æ„ã€å“ç‰Œã€é—¨åº— (2å“ç‰Œ+6é—¨åº—)
psql ybl_restaurant -f data_raw_materials.sql         # åŸææ–™ (229ç§)
psql ybl_restaurant -f data_products_recipes.sql      # æˆå“èœä¸é…æ–¹ (63äº§å“+281é…æ–¹æ˜ç»†)

# ===== é˜¶æ®µ4: è®¢å•ç³»ç»Ÿæ‰©å±•(å¯é€‰) =====
psql ybl_restaurant -f schema_extension_order_system.sql
psql ybl_restaurant -f views_operations_kpi.sql
```

### æ•°æ®ç»Ÿè®¡

| ç±»å‹ | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| è®¡é‡å•ä½ | 22ä¸ª | base(11) + package(7) + usage(4) |
| å“ç‰Œ | 2ä¸ª | å®æ¡‚æå±±é‡çƒ¤è‚‰ã€é‡ç™¾çµè´µå·é…¸æ±¤ç«é”… |
| é—¨åº— | 6å®¶ | ç»µé˜³3+å¾·é˜³1+æ±Ÿæ²¹1+å¸¸ç†Ÿ1 |
| ä¾›åº”å•† | 17å®¶ | æœ¬åœ°+ç½‘è´­+é›†é‡‡ |
| åŸææ–™ | 229ç§ | è‚‰ç±»ã€è”¬èœã€å¹²æ‚ã€æµ·é²œã€é…±æ–™ç­‰ |
| æˆå“èœ | 63ç§ | å«é…æ–¹ |
| é…æ–¹æ˜ç»† | 281æ¡ | å·²å®Œå…¨åˆ†è§£åŠæˆå“ |

### ç¬¬3æ­¥: é…ç½®åŠ å¯†å¯†é’¥

åœ¨ `postgresql.conf` ä¸­æ·»åŠ :

```
app.encryption_key = 'your-secure-key-minimum-32-characters'
```

æˆ–åœ¨ä¼šè¯ä¸­è®¾ç½®:

```sql
SET app.encryption_key = 'your-secure-key-minimum-32-characters';
```

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. åŒæˆæœ¬ç‡è‡ªåŠ¨è®¡ç®—

`sales_detail` è¡¨ä½¿ç”¨ GENERATED åˆ—è‡ªåŠ¨è®¡ç®—:

- **æ ‡å‡†æˆæœ¬ç‡** = ç†è®ºæˆæœ¬ / é”€å”®é¢(æŠ˜å‰) Ã— 100%
- **å®é™…æˆæœ¬ç‡** = ç†è®ºæˆæœ¬ / èœå“æ”¶å…¥(æŠ˜å) Ã— 100% â­æ ¸å¿ƒ
- **æˆæœ¬ç‡å·®å¼‚** = å®é™…æˆæœ¬ç‡ - æ ‡å‡†æˆæœ¬ç‡
- **æ¯›åˆ©ç‡ä¾µèš€** = æŠ˜æ‰£å¯¹æ¯›åˆ©ç‡çš„å½±å“

### 2. BOMé€’å½’åˆ†è§£

æ”¯æŒ11ä¸ªæ ¸å¿ƒåŠæˆå“å®Œå…¨åˆ†è§£åˆ°åŸææ–™:

```sql
-- åˆ†è§£äº§å“101çš„BOM
SELECT * FROM explode_bom(101, 50.0, 1);
```

### 3. å…¨æ–¹ä½æ•°æ®åŠ å¯†

- é…æ–¹æˆæœ¬åŠ å¯†
- åŸææ–™å•ä»·åŠ å¯†
- é”€å”®æ¯›åˆ©åŠ å¯†

### 4. ä¸´æ—¶è¡¨å®¡æ ¸æœºåˆ¶

Excel â†’ stagingè¡¨ â†’ 5è½®éªŒè¯ â†’ äººå·¥å®¡æ ¸ â†’ ç”Ÿäº§è¡¨

---

## ğŸ“Š åŒæˆæœ¬ç‡ç³»ç»Ÿè¯¦è§£

### ä¸ºä»€ä¹ˆéœ€è¦åŒæˆæœ¬ç‡?

**é—®é¢˜**: ä¿ƒé”€æ‰“æŠ˜ä¼šä¾µèš€æ¯›åˆ©,ä½†ä¼ ç»Ÿæˆæœ¬ç‡æ— æ³•é‡åŒ–è¿™ç§å½±å“

**è§£å†³æ–¹æ¡ˆ**: è®¡ç®—ä¸¤ä¸ªæˆæœ¬ç‡å¹¶å¯¹æ¯”

### è®¡ç®—å…¬å¼

```
èœå“æ”¶å…¥ = é”€å”®é¢(æŠ˜å‰) - èœå“ä¼˜æƒ 

æ ‡å‡†æˆæœ¬ç‡ = (ç†è®ºæˆæœ¬ / é”€å”®é¢(æŠ˜å‰)) Ã— 100%
ç”¨é€”: è¯„ä¼°äº§å“æœ¬èº«çš„ç›ˆåˆ©èƒ½åŠ›

å®é™…æˆæœ¬ç‡ = (ç†è®ºæˆæœ¬ / èœå“æ”¶å…¥(æŠ˜å)) Ã— 100%  â­æ ¸å¿ƒ
ç”¨é€”: åæ˜ ä¿ƒé”€åçš„çœŸå®æˆæœ¬å‹åŠ›

æˆæœ¬ç‡å·®å¼‚ = å®é™…æˆæœ¬ç‡ - æ ‡å‡†æˆæœ¬ç‡
ç”¨é€”: é‡åŒ–æŠ˜æ‰£å¯¹æˆæœ¬ç‡çš„å½±å“

æ¯›åˆ©ç‡ä¾µèš€ = æ ‡å‡†æ¯›åˆ©ç‡ - å®é™…æ¯›åˆ©ç‡
ç”¨é€”: é‡åŒ–æŠ˜æ‰£å¯¹æ¯›åˆ©çš„å½±å“
```

### ç¤ºä¾‹

æŸäº§å“:
- é”€å”®æ•°é‡: 10ä»½
- é”€å”®é¢(æŠ˜å‰): 500å…ƒ
- èœå“ä¼˜æƒ : 50å…ƒ
- èœå“æ”¶å…¥(æŠ˜å): 450å…ƒ
- ç†è®ºæˆæœ¬: 200å…ƒ

è®¡ç®—:
- æ ‡å‡†æˆæœ¬ç‡ = 200 / 500 Ã— 100% = **40%**
- å®é™…æˆæœ¬ç‡ = 200 / 450 Ã— 100% = **44.4%**
- æˆæœ¬ç‡å·®å¼‚ = 44.4% - 40% = **+4.4%** (æŠ˜æ‰£ä½¿æˆæœ¬ç‡ä¸Šå‡)

---

## ğŸ“¥ æ•°æ®å¯¼å…¥æµç¨‹

### æ–¹æ³•1: Pythonè„šæœ¬å¯¼å…¥

```python
python3 etl_excel_to_staging.py
```

### æ–¹æ³•2: æ‰‹åŠ¨å¯¼å…¥

```sql
-- 1. å¯¼å…¥Excelåˆ°ä¸´æ—¶è¡¨
\copy staging_sales_detail FROM 'sales.csv' CSV HEADER;

-- 2. æ‰§è¡Œ5è½®éªŒè¯
SELECT validate_staging_sales('batch-uuid');

-- 3. å®¡æ ¸é€šè¿‡åè¿ç§»
SELECT approve_and_migrate_sales('batch-uuid');
```

---

## ğŸ” å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

### 1. æŸ¥è¯¢åŒæˆæœ¬ç‡

```sql
SELECT * FROM v_sales_summary_dual_cost_rate
WHERE year_month = '2025-09'
  AND store_id = 1
ORDER BY actual_cost_rate DESC;
```

### 2. è·¨åº—å¯¹æ¯”

```sql
SELECT * FROM v_cross_store_comparison
WHERE year_month = '2025-09';
```

### 3. åˆ†è§£äº§å“BOM

```sql
SELECT * FROM explode_bom(101, 1.0, 1);
```

### 4. æŸ¥çœ‹åŠ å¯†æˆæœ¬(éœ€æƒé™)

```sql
SELECT
    product_name,
    decrypt_cost(current_cost_encrypted) AS cost
FROM product
WHERE product_id = 1;
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜è¯·æŸ¥çœ‹:
1. PostgreSQLæ—¥å¿—
2. æ•°æ®éªŒè¯æ—¥å¿—è¡¨ `data_validation_log`
3. CLAUDE.md å®Œæ•´æ–‡æ¡£

---

**ç‰ˆæœ¬**: v1.0.0-mvp
**æœ€åæ›´æ–°**: 2025-11-21
