# 业务规则与计算公式

## 双成本率财务分析体系

### 核心公式

```
标准成本率 = 理论成本 / 销售额(折前) × 100%
→ 用途: 评估产品本身的盈利能力

实际成本率 = 理论成本 / 菜品收入(折后) × 100%
→ 用途: 反映促销后的真实成本压力

成本率差异 = 实际成本率 - 标准成本率
→ 用途: 分析折扣促销对利润的侵蚀程度
```

### 收入计算

```
菜品收入 = 销售额(折前) - 菜品优惠
理论成本 = 销售数量 × 产品单品成本
毛利率 = (菜品收入 - 理论成本) / 菜品收入 × 100%
```

**注意**: 永远使用折后收入(菜品收入)作为分母，不要用折前销售额！

---

## BOM递归分解逻辑

### 11个核心半成品
需要完全分解到原材料:
1. 水晶滑肉混合物
2. 香茅酱
3. 干巴菌酱
4. 青柠檬汁
5. 酸辣酱(罗非鱼用)
6. 混合香草
7. 豆腐丸子蘸酱
8. 玉米糊
9. 怪噜洋芋酱
10. 紫苏汤
11. 鸭屎香乌龙茶汤

### 分解公式

```
基础成本 = (产品使用量_g / 半成品售卖份量_g) × 半成品总成本 / 净货率
原材料成本 = 基础成本 × (原材料成本 / 半成品总成本)
```

---

## 单位换算规则

### 标准单位
| 类型 | 基准单位 | 常用换算 |
|-----|---------|---------|
| 重量 | g (克) | 1斤=500g, 1两=50g, 1kg=1000g |
| 体积 | ml (毫升) | 1L=1000ml |
| 计数 | piece (个) | 只、张、枚 → piece |
| 包装 | pack (包) | 袋、盒 → pack |

### 换算原则
- 理论成本计算: 统一转换为克(g)
- 库存管理: 保留原始单位，显示时标注
- 永远显示单位，不做隐式转换

---

## 净货率(出成率)计算

```
实际成本 = 采购价 / 净货率

示例:
- 吊龙采购价: 48元/斤
- 净货率: 83%
- 实际成本: 48 / 0.83 = 57.83元/斤
```

---

## 权限控制规则

### 数据隔离层级
1. **全局** - 总部管理员可查看所有数据
2. **品牌** - 品牌经理只能查看本品牌数据
3. **区域** - 区域经理只能查看本区域门店
4. **门店** - 店长只能查看本门店数据

### 敏感数据
- 配方明细: 需要 `PERM_RECIPE_VIEW` 权限
- 成本数据: 需要 `PERM_COST_VIEW` 权限，加密存储
- 导出功能: 需要 `PERM_*_EXPORT` 权限
