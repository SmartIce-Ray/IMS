# 野百灵数据库项目 - 详细说明

本文档包含项目的详细技术说明、实现细节和注意事项。

---

## 目录

1. [表结构详细说明](#表结构详细说明)
2. [核心函数使用示例](#核心函数使用示例)
3. [公司与品牌架构](#公司与品牌架构)
4. [产品名称规范化](#产品名称规范化)
5. [数据导入注意事项](#数据导入注意事项)
6. [产品编码规则](#产品编码规则)

---

## 表结构详细说明

### 七层架构

```
第一层: 基础设施 (3张)
├── brand          品牌表
├── store          门店表
└── employee       员工表

第二层: 权限管理 (4张)
├── role           角色表
├── permission     权限表
├── role_permission
└── employee_role

第三层: 产品配方 (6张)
├── unit_of_measure    计量单位
├── unit_conversion    单位换算
├── product_category   品类
├── product           产品表 (成品/半成品/原材料统一)
├── recipe            配方表 (多版本)
└── recipe_item       配方明细 (BOM)

第四层: 供应链 (5张)
├── supplier          供应商
├── purchase_order    采购单
├── purchase_order_item
├── inventory         库存主表
└── inventory_transaction

第五层: 销售运营 (6张)
├── sales_detail      销售明细 (双成本率GENERATED列)
├── sales_summary     销售汇总 ⭐已导入数据
├── sales_order       订单主表 (扩展)
├── sales_order_item  订单明细 (扩展)
├── product_alias     产品别名表 (处理繁简体/POS命名差异)
└── group_buy_*       团购相关 (扩展)

第六层: 线上平台 (4张) ⭐已有数据
├── online_platform           平台定义 (美团/点评)
├── store_platform_account    门店平台账号关联
├── platform_daily_metrics    平台日运营数据 (90+字段)
└── v_platform_monthly_summary 月度汇总视图

第七层: 财务审计 (4张)
├── cost_snapshot     成本快照
├── price_history     价格历史
├── audit_log         审计日志
└── data_import_log   导入日志

第八层: SOP管理 (3张)
├── standard_operating_procedure
├── sop_ingredient
└── sop_procedure
```

---

## 核心函数使用示例

### BOM递归分解函数

**用途**: 将产品分解为原材料清单

```sql
-- 分解产品到原材料
-- 参数: product_id, quantity, brand_id
SELECT * FROM explode_bom(
    (SELECT product_id FROM product WHERE product_name = '云山雪花吊龙'),
    1.0,  -- 数量
    1     -- 品牌ID
);

-- 计算产品总成本
SELECT calculate_product_total_cost(
    (SELECT product_id FROM product WHERE product_name = '云山雪花吊龙')
);
```

### 成本加密/解密函数

**用途**: 保护敏感成本数据

```sql
-- 设置加密密钥
SET app.encryption_key = 'ybl-restaurant-encryption-key-2025';

-- 加密成本
SELECT encrypt_cost(123.45);
-- 返回: \x...加密的字节流

-- 解密成本 (需要相应权限)
SELECT decrypt_cost('\x...'::bytea);
-- 返回: 123.45
```

### 双成本率分析视图

```sql
-- 查看某门店的成本率分析
SELECT * FROM v_financial_analysis
WHERE store_id = 1
ORDER BY sales_date DESC
LIMIT 10;

-- 字段说明:
-- theoretical_cost_rate: 理论成本率 (基于SOP标准用量)
-- actual_cost_rate: 实际成本率 (基于实际采购/库存数据)
-- variance: 成本率差异 (实际 - 理论)
```

---

## 公司与品牌架构

### 公司信息

| 公司名称 | 成立日期 | 法人 | 业务范围 |
|---------|---------|------|----------|
| 有点东西餐饮管理有限公司 | 2024-XX-XX | XXX | 餐饮管理、食品销售 |

### 品牌信息

| brand_id | 品牌名称 | 品牌代码 | 定位 | 客单价 | 状态 |
|----------|---------|---------|------|--------|------|
| 1 | 野百灵贵州酸汤 | YBL | 中高端贵州酸汤火锅 | ¥80-120 | 运营中 |
| 2 | 宁桂杏山野烤肉 | NGX | 中高端烤肉 | ¥100-150 | 运营中 |
| 3 | 邦兰埔东南亚Bistro | BLP | 东南亚轻餐饮 | ¥60-80 | 规划中 |

### 门店详细信息

#### 野百灵品牌门店

| store_id | 店名 | 城市 | 地址 | 面积 | 座位数 | 店长 | 开业日期 |
|----------|------|------|------|------|--------|------|----------|
| 1 | 野百灵贵州酸汤火锅（德阳店） | 德阳 | 四川省德阳市XX区XX路XX号 | 300㎡ | 20桌 | 杨攀 | 2025-08-23 |
| 2 | 野百灵贵州酸汤火锅（1958店） | 绵阳 | 四川省绵阳市涪城区1958商业街 | 400㎡ | 25桌 | 梁笑天 | 2025-06-04 |

#### 宁桂杏品牌门店

| store_id | 店名 | 城市 | 地址 | 面积 | 座位数 | 店长 | 开业日期 |
|----------|------|------|------|------|--------|------|----------|
| 7 | 宁桂杏山野烤肉（1958店） | 绵阳 | 四川省绵阳市涪城区1958商业街 | 350㎡ | 22桌 | 雷军 | 2025-01-01 |
| 8 | 宁桂杏山野烤肉（世贸店） | 常熟 | 江苏省苏州市常熟市世贸广场 | 450㎡ | 28桌 | 姜德刚 | 2025-03-08 |
| 3 | 宁桂杏山野烤肉（上马Young Park） | 绵阳 | 四川省绵阳市涪城区上马XX路 | 320㎡ | 20桌 | 刘雪梅 | 2025-07-01 |
| 4 | 宁桂杏山野烤肉（江油首店） | 江油 | 四川省江油市XX路XX号 | 280㎡ | 18桌 | 薛连 | 2025-10-01 |

### 数据导入状态

| 门店 | 销售汇总数据 | 平台数据(美团) | 平台数据(点评) | 入库单 | 盘点表 |
|------|-------------|---------------|---------------|--------|--------|
| 野百灵德阳店 | ✅ | ❌ | ❌ | ✅ | ❌ |
| 野百灵1958店 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 宁桂杏1958店 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 宁桂杏世贸店 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 宁桂杏上马店 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 宁桂杏江油店 | ✅ | ❌ | ❌ | ❌ | ❌ |

---

## 产品名称规范化

### 规范化规则

使用 `utils/normalize_name.py` 进行产品名称标准化:

1. **繁体字 → 简体字**
   - 紙 → 纸
   - 麵 → 面
   - 雞 → 鸡
   - 蝦 → 虾

2. **全角括号 → 半角括号**
   - （ → (
   - ） → )

3. **去除首尾空格**

### 产品别名表 (product_alias)

用于处理POS系统命名差异和历史遗留问题:

| 别名 | 标准名称 | 来源 | 说明 |
|------|----------|------|------|
| 无粉紙巾 | 无粉纸巾 | traditional | 繁体字转换 |
| 糟辣椒炒饭 | 糟辣椒蛋炒饭 | pos_mianyang | POS系统简称 |
| 雪花牛肉 | 云山雪花吊龙 | pos_legacy | 历史名称 |

### 使用示例

```sql
-- 通过别名查找产品
SELECT p.*
FROM product p
LEFT JOIN product_alias pa ON p.product_id = pa.product_id
WHERE p.product_name = '无粉纸巾' OR pa.alias_name = '无粉紙巾';
```

---

## 数据导入注意事项

### Excel读取陷阱

#### 1. 合计行问题

**问题**: Excel最后一行通常是合计，pandas读取时会被当作数据行

**解决方案**:
```python
import pandas as pd

# 方法1: 读取时排除最后一行
df = pd.read_excel('销售统计.xlsx', skipfooter=1)

# 方法2: 读取后过滤
df = pd.read_excel('销售统计.xlsx')
df = df[df['菜品名称'] != '合计']

# 方法3: 识别合计行特征
df = df[pd.notna(df['菜品名称'])]
```

#### 2. 销售额构成列

**问题**: 包含菜品/关联做法/关联加料/关联餐盒的明细分列，容易重复计算

**解决方案**:
```python
# 只使用"菜品销售额"列，不要累加其他列
sales_amount = df['菜品销售额'].sum()

# 不要这样做:
# wrong_total = df['菜品销售额'].sum() + df['关联做法'].sum()  # 会重复计算
```

#### 3. skiprows参数

**菜品销售统计Excel**: 通常前2行是标题和说明文字，需要跳过

```python
df = pd.read_excel('WL德阳店菜品销售统计.xlsx', skiprows=2)
```

### 不导入的数据类型

#### 1. 临时商品
- 特征: 销售额通常很小（<¥100）
- 示例: 测试商品、临时促销品
- 处理: 导入时过滤或标记为 `is_active = false`

#### 2. 销售额为0的项目
- 特征: 销售额=0 但有销售数量，通常是赠品或营销文案
- 示例: "非遗传承30年"、"高山辣椒"
- 处理: 不导入或标记为营销类型

#### 3. 自助小料明细
- 特征: 自助小料的细分项
- 示例: "香菜"、"葱花"、"辣椒油" (已包含在"非遗手工蘸料"中)
- 处理: 不导入，避免重复计算

---

## 产品编码规则

### 编码格式

`{品牌前缀}-{产品类型}-{序号}`

### 品牌前缀

| 品牌 | 前缀 |
|------|------|
| 野百灵贵州酸汤 | YBL |
| 宁桂杏山野烤肉 | NGX |
| 邦兰埔东南亚Bistro | BLP |

### 产品类型

| 类型代码 | 类型名称 | 说明 | 示例 |
|---------|---------|------|------|
| FP | Finished Product | 成品菜 | YBL-FP-001 云山雪花吊龙 |
| SF | Semi-Finished | 半成品 | YBL-SF-001 香茅酱 |
| RM | Raw Material | 原材料 | YBL-RM-001 吊龙 |
| JS | 酒水类 | 酒水饮料 | NGX-JS-001 纯生 |
| RY | 软饮类 | 软饮 | NGX-RY-001 可口可乐 |
| HC | 耗材类 | 餐具耗材 | YBL-HC-001 无粉纸巾 |
| ZL | 蘸料类 | 蘸料 | YBL-ZL-001 非遗手工蘸料 |
| ZS | 主食类 | 主食 | YBL-ZS-001 糟辣椒蛋炒饭 |
| TP | 甜品类 | 甜品 | NGX-TP-001 冰淇淋 |
| XL | 小料类 | 小料配菜 | YBL-XL-001 香菜 |
| HX | 海鲜类 | 海鲜 | YBL-HX-001 基围虾 |

### 编码示例

```sql
-- 野百灵产品编码示例
YBL-FP-001  云山雪花吊龙 (成品菜)
YBL-SF-001  香茅酱 (半成品)
YBL-RM-001  吊龙 (原材料)
YBL-JS-001  雪花纯生 (酒水)
YBL-HC-001  无粉纸巾 (耗材)

-- 宁桂杏产品编码示例
NGX-FP-001  黄油厚切猪五花 (成品菜)
NGX-FP-102  酸菜五花肉 (成品菜)
NGX-JS-001  青岛纯生 (酒水)
NGX-RY-001  可口可乐(听) (软饮)
```

---

## 销售数据详细统计

### 野百灵品牌

| 门店 | 统计周期 | 产品数 | 销售额(折前) | 菜品优惠 | 菜品收入(折后) | 优惠率 |
|------|----------|--------|--------------|----------|----------------|--------|
| 德阳店 | 2025-08至10 | 86 | ¥1,086,608.00 | ¥111,325.59 | ¥975,282.41 | 10.2% |
| 1958店 | 2025-06至10 | 96 | ¥2,609,287.64 | ¥256,227.16 | ¥2,353,060.48 | 9.8% |
| **野百灵合计** | | **102** | **¥3,695,895.64** | **¥367,552.75** | **¥3,328,342.89** | **9.9%** |

### 宁桂杏品牌

| 门店 | 统计周期 | 产品数 | 销售额(折前) | 菜品优惠 | 菜品收入(折后) | 优惠率 |
|------|----------|--------|--------------|----------|----------------|--------|
| 1958店 | 2025-01至11 | 109 | ¥5,070,193.00 | ¥351,334.72 | ¥4,718,858.28 | 6.9% |
| 世贸店 | 2025-03至11 | 106 | ¥5,070,266.00 | ¥485,593.17 | ¥4,584,672.83 | 9.6% |
| 上马店 | 2025-07至11 | 88 | ¥3,549,038.00 | ¥458,544.06 | ¥3,090,493.94 | 12.9% |
| 江油店 | 2025-09至11 | 83 | ¥800,593.00 | ¥44,475.68 | ¥756,117.32 | 5.6% |
| **宁桂杏合计** | | **174** | **¥14,490,090.00** | **¥1,339,947.63** | **¥13,150,142.37** | **9.2%** |

### 集团总计

| 指标 | 数值 |
|-----|------|
| 总销售额(折前) | ¥18,185,985.64 |
| 总菜品优惠 | ¥1,707,500.38 |
| 总菜品收入(折后) | ¥16,478,485.26 |
| 整体优惠率 | 9.4% |
| 产品总数 | 276 (去重后) |
| 销售记录数 | 567条 |

---

## 线上平台数据详细统计

### 美团平台

| 门店 | 日期范围 | 记录数 | 成交额(优惠前) | 实收金额 | 优惠率 |
|------|----------|--------|---------------|----------|--------|
| 宁桂杏1958店 | 2025-01-01~11-22 | 326 | ¥2,543,381.50 | ¥2,234,567.89 | 12.1% |
| 宁桂杏世贸店 | 2025-01-20~11-22 | 307 | ¥1,283,372.10 | ¥1,156,789.23 | 9.9% |
| 野百灵1958店 | 2025-06-01~11-22 | 175 | ¥1,120,973.50 | ¥998,765.43 | 10.9% |

### 点评平台

| 门店 | 日期范围 | 记录数 | 成交额(优惠前) | 实收金额 | 优惠率 |
|------|----------|--------|---------------|----------|--------|
| 宁桂杏1958店 | 2025-01-01~11-22 | 326 | ¥474,781.00 | ¥428,123.45 | 9.8% |
| 宁桂杏世贸店 | 2025-01-20~11-22 | 307 | ¥1,538,469.60 | ¥1,389,234.56 | 9.7% |
| 野百灵1958店 | 2025-06-01~11-22 | 175 | ¥274,408.00 | ¥247,890.12 | 9.7% |

---

## 附录

### 常用查询示例

```sql
-- 1. 查看某门店的产品销售排名
SELECT
    product_name,
    SUM(sales_quantity) as total_quantity,
    SUM(sales_amount) as total_amount
FROM sales_summary ss
JOIN product p ON ss.product_id = p.product_id
WHERE store_id = 1
GROUP BY product_name
ORDER BY total_amount DESC
LIMIT 20;

-- 2. 查看某产品的成本构成
SELECT * FROM explode_bom(
    (SELECT product_id FROM product WHERE product_name = '云山雪花吊龙'),
    1.0,
    1
);

-- 3. 对比理论成本率和实际成本率
SELECT
    store_name,
    AVG(theoretical_cost_rate) as avg_theoretical_cost_rate,
    AVG(actual_cost_rate) as avg_actual_cost_rate,
    AVG(actual_cost_rate - theoretical_cost_rate) as avg_variance
FROM v_financial_analysis
GROUP BY store_name;
```

### 参考资料

- PostgreSQL官方文档: https://www.postgresql.org/docs/15/
- pgcrypto加密扩展: https://www.postgresql.org/docs/15/pgcrypto.html
- pandas数据处理: https://pandas.pydata.org/
