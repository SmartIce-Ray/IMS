# 数据库架构设计

## 系统架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (API/Web/Mobile)                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│               业务逻辑层 (存储过程/函数/触发器)               │
│  - BOM递归分解      - 成本自动计算    - 库存自动更新         │
│  - 双成本率计算     - 单位自动换算    - 审计日志记录         │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据持久层 (37张表)                     │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ 组织架构层   │  │ 产品配方层   │  │  供应链层    │       │
│  │  (5张表)     │  │  (6张表)     │  │  (5张表)     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ 销售运营层   │  │ 财务分析层   │  │ 系统支持层   │       │
│  │  (8张表)     │  │  (4张表)     │  │  (3张表)     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                 PostgreSQL 存储引擎                          │
│  - B-Tree索引    - GiST索引      - 分区表                    │
│  - JSON支持      - 递归CTE       - 物化视图                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心实体关系图 (ER Diagram)

```
                    ┌─────────────────┐
                    │ organization    │
                    │     _unit       │
                    │  (树形结构)     │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              ↓              ↓              ↓
      ┌───────────┐   ┌───────────┐   ┌───────────┐
      │   brand   │   │   store   │   │ warehouse │
      │   品牌    │──→│   门店    │←──│   仓库    │
      └─────┬─────┘   └─────┬─────┘   └─────┬─────┘
            │               │               │
            ↓               │               ↓
      ┌───────────┐         │         ┌───────────┐
      │  product  │←────────┘         │ inventory │
      │   产品    │                   │   库存    │
      │(成品/半成品/原材料)           └─────┬─────┘
      └─────┬─────┘                         │
            │                               ↓
            ↓                   ┌───────────────────┐
      ┌───────────┐             │ inventory         │
      │  recipe   │             │ _transaction      │
      │   配方    │             │ 库存交易          │
      │(多版本)   │             └───────────────────┘
      └─────┬─────┘
            │
            ↓
      ┌───────────┐         ┌───────────┐
      │ recipe    │         │ sales     │
      │ _item     │         │ _order    │
      │ BOM明细   │         │ 销售订单  │
      └───────────┘         └─────┬─────┘
                                  │
                                  ↓
                            ┌───────────┐
                            │ sales     │
                            │ _detail   │
                            │ 销售明细  │
                            │(双成本率) │
                            └───────────┘
```

---

## 双成本率数据流

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  销售数据    │     │  配方数据    │     │  原材料价格  │
│ sales_order  │     │   recipe     │     │   product    │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │
       ↓                    ↓                    ↓
┌──────────────────────────────────────────────────────────┐
│                    BOM递归分解函数                        │
│                    explode_bom()                          │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐              │
│  │ 成品    │ →  │ 半成品  │ →  │ 原材料  │              │
│  └─────────┘    └─────────┘    └─────────┘              │
└──────────────────────────────────────────────────────────┘
                         │
                         ↓
┌──────────────────────────────────────────────────────────┐
│                   sales_detail 表                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ GENERATED 列自动计算:                                │ │
│  │                                                      │ │
│  │ theoretical_cost = 销售数量 × 产品单成本             │ │
│  │                                                      │ │
│  │ standard_cost_rate = theoretical_cost / presales    │ │
│  │                      (理论成本/折前收入)             │ │
│  │                                                      │ │
│  │ actual_cost_rate = theoretical_cost / product_revenue│ │
│  │                    (理论成本/折后收入) ⭐核心        │ │
│  │                                                      │ │
│  │ cost_rate_variance = actual - standard              │ │
│  │                      (成本率差异=促销侵蚀)           │ │
│  └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
                         │
                         ↓
┌──────────────────────────────────────────────────────────┐
│                   分析视图层                              │
│  v_product_profitability     产品盈利分析                │
│  v_store_cost_comparison     门店成本对比                │
│  v_ingredient_cost_ranking   原材料成本排名              │
└──────────────────────────────────────────────────────────┘
```

---

## 产品层级与BOM结构

```
                    ┌─────────────────────────┐
                    │      成品 (finished)     │
                    │   如: 云山雪花吊龙       │
                    │   售价: 138元/份         │
                    └───────────┬─────────────┘
                                │
           ┌────────────────────┼────────────────────┐
           ↓                    ↓                    ↓
   ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
   │ 半成品         │    │ 原材料        │    │ 原材料        │
   │ (semi_finished)│    │ (raw_material)│    │ (raw_material)│
   │ 紫苏汤         │    │ 吊龙 250g     │    │ 木姜子 5g     │
   └───────┬───────┘    └───────────────┘    └───────────────┘
           │
    ┌──────┴──────┐
    ↓             ↓
┌─────────┐  ┌─────────┐
│ 紫苏叶  │  │  清水   │
│  30g    │  │ 200ml   │
└─────────┘  └─────────┘

                    11个核心半成品需要完全分解:
┌──────────────────────────────────────────────────────────┐
│ 1. 水晶滑肉混合物   7. 豆腐丸子蘸酱                      │
│ 2. 香茅酱           8. 玉米糊                            │
│ 3. 干巴菌酱         9. 怪噜洋芋酱                        │
│ 4. 青柠檬汁        10. 紫苏汤                            │
│ 5. 酸辣酱(罗非鱼用) 11. 鸭屎香乌龙茶汤                   │
│ 6. 混合香草                                              │
└──────────────────────────────────────────────────────────┘
```

---

## 权限控制架构

```
┌─────────────────────────────────────────────────────────────┐
│                        员工 (employee)                       │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     员工角色 (employee_role)                 │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │ 作用域  │  │ 作用域  │  │ 作用域  │  │ 作用域  │        │
│  │ global  │  │ brand   │  │ region  │  │ store   │        │
│  │ 全局    │  │ 品牌级  │  │ 区域级  │  │ 门店级  │        │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        角色 (role)                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ 超级管理员   │  │ 财务经理     │  │ 店长         │       │
│  │ level=0      │  │ level=0      │  │ level=2      │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     权限 (permission)                        │
│  ┌────────────────┐  ┌────────────────┐                     │
│  │ PERM_COST_VIEW │  │ PERM_RECIPE_EDIT│                    │
│  │ 查看成本       │  │ 编辑配方        │                    │
│  └────────────────┘  └────────────────┘                     │
│  ┌────────────────┐  ┌────────────────┐                     │
│  │ PERM_SALES_VIEW│  │ PERM_COST_EXPORT│                   │
│  │ 查看销售       │  │ 导出成本数据    │                    │
│  └────────────────┘  └────────────────┘                     │
└─────────────────────────────────────────────────────────────┘

数据隔离示例:
┌─────────────────────────────────────────────────────────────┐
│ 店长(德阳店) → 只能看德阳店数据                              │
│ 区域经理    → 只能看四川区域所有门店                         │
│ 财务经理    → 可看所有门店，但不能编辑配方                   │
│ 超级管理员  → 全部权限                                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 库存管理架构

```
┌─────────────────────────────────────────────────────────────┐
│                      供应商 (supplier)                       │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    采购订单 (purchase_order)                 │
│                              │                               │
│                    采购明细 (purchase_order_item)            │
└─────────────────────────────┬───────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ↓               ↓               ↓
      ┌───────────┐   ┌───────────┐   ┌───────────┐
      │ 中央仓库  │   │ 德阳门店  │   │ 绵阳门店  │
      │ warehouse │   │ warehouse │   │ warehouse │
      │ type=     │   │ type=     │   │ type=     │
      │ central   │   │ store     │   │ store     │
      └─────┬─────┘   └─────┬─────┘   └─────┬─────┘
            │               │               │
            └───────────────┼───────────────┘
                            ↓
      ┌─────────────────────────────────────────────────┐
      │              库存主表 (inventory)                │
      │  - quantity_on_hand     实际库存                │
      │  - quantity_reserved    预留库存                │
      │  - quantity_available   可用库存 (GENERATED)    │
      │  - minimum_quantity     最低库存 (预警线)       │
      │  - reorder_point        再订货点                │
      └─────────────────────────┬───────────────────────┘
                                │
                                ↓
      ┌─────────────────────────────────────────────────┐
      │          库存交易 (inventory_transaction)        │
      │  type: purchase | sale | transfer | adjustment  │
      │  ┌─────────────────────────────────────────┐    │
      │  │ 每笔交易记录:                           │    │
      │  │ - quantity_before  交易前库存           │    │
      │  │ - quantity         变动量 (+入/-出)     │    │
      │  │ - quantity_after   交易后库存           │    │
      │  └─────────────────────────────────────────┘    │
      └─────────────────────────────────────────────────┘
```

---

## 数据安全设计

```
┌─────────────────────────────────────────────────────────────┐
│                     敏感数据加密 (pgcrypto)                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  加密字段:                                                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ product.current_cost_encrypted        产品当前成本   │    │
│  │ recipe.total_cost_encrypted           配方总成本     │    │
│  │ recipe_item.unit_price_encrypted      原料单价       │    │
│  │ recipe_item.subtotal_cost_encrypted   原料小计成本   │    │
│  │ inventory.unit_cost_encrypted         库存单位成本   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  加密函数:                                                   │
│  encrypt_cost(decimal) → bytea                              │
│  decrypt_cost(bytea)   → decimal  (需SECURITY DEFINER权限)  │
│                                                              │
│  脱敏视图:                                                   │
│  v_product_masked_cost  成本显示为区间: "<10元", "10-30元"  │
│                                                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     审计日志 (audit_log)                     │
├─────────────────────────────────────────────────────────────┤
│  记录所有敏感操作:                                           │
│  - 配方修改                                                  │
│  - 成本数据查看/导出                                         │
│  - 权限变更                                                  │
│  - 数据导入/删除                                             │
│                                                              │
│  字段: 操作人 | 操作时间 | 操作类型 | 变更前 | 变更后       │
└─────────────────────────────────────────────────────────────┘
```

---

## 扩展能力设计

```
当前: 2品牌 × 6门店 = 12个数据隔离域
目标: 2品牌 × 50门店 = 100个数据隔离域

┌─────────────────────────────────────────────────────────────┐
│                     水平扩展策略                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 表分区 (sales_detail 按月分区)                          │
│     ┌──────────┐ ┌──────────┐ ┌──────────┐                 │
│     │ 2025_09  │ │ 2025_10  │ │ 2025_11  │                 │
│     └──────────┘ └──────────┘ └──────────┘                 │
│                                                              │
│  2. 索引优化                                                 │
│     - 复合索引: (store_id, sales_date)                      │
│     - 部分索引: WHERE is_active = TRUE                      │
│     - GIN索引:  产品名称模糊搜索                            │
│                                                              │
│  3. 物化视图 (预计算汇总)                                    │
│     - v_daily_sales_summary                                 │
│     - v_monthly_cost_analysis                               │
│                                                              │
│  4. 读写分离 (未来)                                          │
│     - 主库: 写入操作                                        │
│     - 从库: 报表查询                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘

预估数据量 (3年):
┌─────────────────────────────────────────────────────────────┐
│ 表名                    │ 年增长量    │ 3年总量             │
├─────────────────────────┼─────────────┼─────────────────────┤
│ sales_detail            │ 500万条/年  │ 1500万条            │
│ inventory_transaction   │ 100万条/年  │ 300万条             │
│ audit_log               │ 50万条/年   │ 150万条             │
│ product                 │ 500条/年    │ 2000条              │
│ recipe                  │ 1000条/年   │ 4000条              │
└─────────────────────────────────────────────────────────────┘
```
