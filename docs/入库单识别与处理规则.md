# 入库单识别与处理规则

**创建日期**: 2025-11-24
**适用范围**: 手写入库单/送货单的OCR识别与数据验证

---

## 一、文件位置

```
野百灵入库单/
├── WechatIMG900.jpg ~ WechatIMG904.jpg  # 原始入库单照片
├── 入库单汇总_YYYY-MM-DD.md             # 整理后的汇总报告
└── 入库单交叉验证_YYYY-MM-DD.md         # 交叉验证过程记录
```

---

## 二、交叉验证方法 (核心)

### 验证原则

1. **单项验证**: 数量 × 单价 = 金额
2. **总额验证**: 各项金额加总 = 票据合计
3. **合理性验证**: 价格在正常范围内

### 验证流程

```
1. 先识别票据合计金额（通常在底部，相对清晰）
2. 逐行计算 数量×单价，检查是否等于金额列
3. 将所有金额加总，检查是否等于票据合计
4. 若差异大，用合计倒推修正有疑问的项
5. 检查单价是否合理（参考市场价）
```

### 验证脚本示例

```python
def validate_delivery_note(items, expected_total):
    """交叉验证入库单"""
    calculated_total = 0
    issues = []

    for item in items:
        qty, price, amount = item['qty'], item['price'], item['amount']
        calc_amount = qty * price

        # 单项验证
        if abs(calc_amount - amount) > 0.5:
            issues.append(f"{item['name']}: {qty}×{price}={calc_amount} ≠ {amount}")

        calculated_total += amount

    # 总额验证
    diff = abs(calculated_total - expected_total)
    if diff > 1:
        issues.append(f"总额差异: 计算{calculated_total} vs 票据{expected_total}")

    return calculated_total, issues
```

---

## 三、手写数字识别常见错误

### 小数点遗漏 (最常见)

| 原识别 | 正确值 | 场景 |
|--------|--------|------|
| 43 | 4.3 | 小葱单价 |
| 45 | 4.5 | 芹菜/黄瓜单价 |
| 13 | 1.3 | 白萝卜单价 |
| 15 | 1.5 | 豆芽单价 |

### 小数位移位

| 原识别 | 正确值 | 场景 |
|--------|--------|------|
| 7.6 | 0.76 | 绿大豆数量 |
| 12 | 1.2 | 小米辣数量 |
| 27 | 2.7 | 肉沫数量 |

### 识别规律

- 当单项金额导致总额超出票据合计时，优先检查小数点位置
- 蔬菜单价通常在1-10元/斤，超过20元需警惕
- 豆芽类单价通常1-3元/斤，15元/斤明显异常

---

## 四、计量单位转换

### 数据库基础单位

| 类型 | 基础单位 | unit_id |
|------|----------|---------|
| 重量 | g (克) | 1 |
| 体积 | ml (毫升) | 7 |
| 计数 | piece (个) | 10 |

### 常用换算

| 原单位 | 换算 | 示例 |
|--------|------|------|
| 斤 | ×500 → g | 3斤 → 1500g |
| 两 | ×50 → g | 5两 → 250g |
| 千克/kg | ×1000 → g | 2kg → 2000g |

### 单价/克计算

```python
# 计算标准化单价
price_per_gram = price_per_jin / 500  # 精确到4位小数
# 示例：4.3元/斤 → 0.0086元/g
```

---

## 五、正常价格范围参考

### 蔬菜类 (元/斤)

| 品类 | 价格范围 | 备注 |
|------|---------|------|
| 叶菜类 | 1-5 | 小白菜、生菜等 |
| 根茎类 | 1-3 | 白萝卜、土豆等 |
| 豆芽类 | 1-3 | 绿豆芽、黄豆芽 |
| 调味蔬菜 | 3-10 | 小葱、香菜、辣椒 |
| 菌菇类 | 5-35 | 金针菇12元，杏鲍菇32元 |
| 特殊蔬菜 | 10-50 | 人参苗、绿大豆等 |

### 海鲜类 (元/斤)

| 品类 | 价格范围 |
|------|---------|
| 基围虾 | 30-40 |
| 生蚝 | 8-15 |
| 8头鲍 | 60-80 |
| 鲜鱼 | 10-20 |
| 罗非鱼 | 15-20 |

---

## 六、案例记录

### Case 1: 2025-11-24 入库单验证

**验证结果**:

| 单据 | 票据合计 | 验算合计 | 差异 | 状态 |
|------|----------|----------|------|------|
| 送货单8165504 (德阳) | ¥99 | ¥98.80 | ¥0.20 | ✓ 通过 |
| 送货单8165502 (1958) | ¥208 | ¥208.20 | ¥0.20 | ✓ 通过 |
| 送货单8165501 (1958) | ¥318 | ¥372.15 | ¥54.00 | ⚠️ 需核对 |
| 展浪餐饮 (海鲜) | ¥189.90 | ¥197.90 | ¥8.00 | ⚠️ 需核对 |
| 味自然食品 | ¥39 | ¥39.00 | ¥0 | ✓ 通过 |

**修正统计**: 通过交叉验证，共修正12项小数点识别错误

**关键修正项**:

| 品名 | 原识别 | 修正后 | 修正原因 |
|------|--------|--------|----------|
| 白萝卜 | 13元/斤 | 1.3元/斤 | 总额验证超出 |
| 小葱 | 41.67元/斤 | 4.3元/斤 | 价格不合理 |
| 芹菜 | 45元/斤 | 4.5元/斤 | 价格不合理 |
| 黄瓜 | 45元/斤 | 4.5元/斤 | 价格不合理 |
| 绿大豆 | 7.6斤 | 0.76斤 | 总额验证超出 |
| 小米辣 | 12斤 | 1.2斤 | 总额验证超出 |
| 枸杞芽 | 45元/包 | 4.5元/包 | 总额验证超出 |
| 绿豆芽 | 15元/斤 | 1.5元/斤 | 价格不合理 |
| 黄豆芽 | 15元/斤 | 1.5元/斤 | 价格不合理 |

---

## 七、相关文件

- `野百灵入库单/入库单汇总_2025-11-24.md` - 首次应用此规则的汇总报告
- `野百灵入库单/入库单交叉验证_2025-11-24.md` - 详细验证过程
